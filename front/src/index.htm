<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="../modules//tabulator-master/dist/css/tabulator.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../modules//jPlayer-master/dist/skin/blue.monday/css/jplayer.blue.monday.css">
    <link rel="stylesheet" href="./global.css">

    <!-- js -->
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="../modules//tabulator-master/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jplayer/2.9.2/jplayer/jquery.jplayer.js"></script>
    <script src="../modules/jquery-template-master/dist/jquery.loadTemplate.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
    <script src="./global.js"></script>

</head>
<body>
<div class="container-fluid">
    <!-- ヘッダー -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Navbar</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                        Dropdown
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Something else here</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="#">Disabled</a>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0">
                <input id="searchInput" class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0" type="button" onclick="onClickSearchButton()">Search</button>
            </form>
        </div>
    </nav>
    <!-- 中身 -->
    <div class="row contents_row">
        <div class="col-2" style="padding: 0;">
            <div class="bg-light border-right" id="sidebar-wrapper">
                <div class="sidebar-heading">Start Bootstrap </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action bg-light">Dashboard</a>
                    <a href="#" class="list-group-item list-group-item-action bg-light">Shortcuts</a>
                    <a href="#" class="list-group-item list-group-item-action bg-light">Overview</a>
                    <a href="#" class="list-group-item list-group-item-action bg-light">Events</a>
                    <a href="#" class="list-group-item list-group-item-action bg-light">Profile</a>
                    <a href="#" class="list-group-item list-group-item-action bg-light">Status</a>
                </div>
            </div>
        </div>
        <div id="loading" class="col-10 loading_row">
            <div class="row">
                <!-- 曲一覧 -->
                <div id="contentsList" class="col-12 contentsList"></div>
            </div>
            <!-- Tabulator -->
            <div id="example-table" style="visibility: hidden;"></div>
        </div>
    </div>
    <div class="row">
        <!-- サウンドプレーヤー -->
        <div class="col-12 audio_wrapper">
            <div id="audio_player" class="jp-jplayer"></div>
            <div id="jp_container_1" class="jp-audio" style="width: auto;">
                <div class="jp-type-single">
                    <div class="row">
                        <div class="col-4"></div>
                        <div class="col-4">
                            <div class="jp-gui jp-interface">
                                <ul class="jp-controls">
                                    <li><a href="#" class="jp-play" tabindex="1">play</a></li>
                                    <li><a href="#" class="jp-pause" tabindex="1">pause</a></li>
                                    <li><a href="#" class="jp-stop" tabindex="1">stop</a></li>
                                    <li><a href="#" class="jp-mute" tabindex="1" title="mute">mute</a></li>
                                    <li><a href="#" class="jp-unmute" tabindex="1" title="unmute">unmute</a></li>
                                    <li><a href="#" class="jp-volume-max" tabindex="1" title="max volume">max volume</a></li>
                                </ul>
                                <div class="jp-progress">
                                    <div class="jp-seek-bar">
                                        <div class="jp-play-bar"></div>
                                    </div>
                                </div>
                                <div class="jp-volume-bar">
                                    <div class="jp-volume-bar-value"></div>
                                </div>
                                <div class="jp-time-holder">
                                    <div class="jp-current-time"></div>
                                    <div class="jp-duration"></div>
                                    <ul class="jp-toggles">
                                        <li><a href="#" class="jp-repeat" tabindex="1" title="repeat">repeat</a></li>
                                        <li><a href="#" class="jp-repeat-off" tabindex="1" title="repeat off">repeat off</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-4"></div>
                    </div>
                    <div class="jp-title">
                        <ul>
                            <li><a id="a_artist">-</a> / <a id="a_title">-</a></li>
                        </ul>
                    </div>
                    <div class="jp-no-solution">
                        <span>Update Required</span>
                        To play the media you will need to either update your browser to a recent version or update your <a
                            href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</div id='container'>

<script>
    $(window).load(() => { $('#loading').hide(); })
</script>

<script>
    $("#audio_player").jPlayer({
        /* イベントハンドラ */
        ready: function () {
            /* 再生するメディアの定義 */
            $(this).jPlayer("setMedia", {
                mp3: "../tmp/sample1.mp3",   /* mp3 */
            }) /* 自動再生 */
        },
        /* プレロード（デフォルトは'metadata'、プレロードする場合は'auto'） */
        preload: "metadata",
        /* 音量（デフォルトは0.8、指定可能な値の範囲は0～1） */
        volume: 0.5,
        /* ミュートの有無（デフォルトはfalse）*/
        muted: false,
        /* 背景色*/
        backgroundColor: "#ff6699",
        /* エラーアラート表示の有無（デフォルトはfalse） */
        errorAlerts: false,
        /* 警告アラート表示の有無（デフォルトはfalse） */
        warningAlerts: false,
        /* 最後まで再生された時 */
        ended: function (event) {
            /* また再生する */
            //$(this).jPlayer("play");
        },
        /* Jplayer.swfのパス */
        swfPath: "../modules/jPlayer-master/dist/jplayer/jquery.jplayer.swf",
        /* ソリューションの優先度（デフォルトは\"html, flash\") */
        solution: 'html, flash',
        /* フォーマット（デフォルトはmp3、カンマ区切りで複数指定可、優先度は左が高）*/
        /* 指定可能なフォーマットは、mp3, m4a, m4v, oga, ogv, wav, webma, webmv */
        /* 音声ならmp3 or m4a、動画ならm4v */
        supplied: "mp3",
        wmode: "window"
    })
    .bind($.jPlayer.event.play, () => {
        $(this).jPlayer("pauseOthers");
    });
</script>
<script>
    function CreateContent(data) {
        $('#contentsList').loadTemplate(
            '../template/content.htm',
            {
                'artist': data.artist,
                'album': data.title,
                'fileName': data.fileName,
            },
            { append: true });
    }
</script>
<script>
    function UpdatePlayer(c, b) {
        $('#a_artist')[0].innerHTML = c.artist;
        $('#a_title')[0].innerHTML = c.title;
        $("#audio_player").jPlayer("setMedia", {
            mp3: b,   /* mp3 */
        }).jPlayer('play'); /* 自動再生 */
    }

    function GetMusic(d) {
        $(() => {
            var xhr = new XMLHttpRequest();
            //xhr.open('POST', 'https://localhost:44322/api/v1/sound');//http://localhost:8080/sound/
            xhr.open('POST', 'http://localhost:5000/api/v1/sound/');
            xhr.setRequestHeader('Content-Type', 'application/problem+json');
            xhr.onerror = () => {
                console.log("erroe!");
            }
            xhr.onload = () => {
                let c = JSON.parse(xhr.response);
                UpdatePlayer(c, createBinaryFromBase64(c.content));
            };
            xhr.send(JSON.stringify({ fileName: d }));
        });
    }

    function GetContents() {
        var xhr = new XMLHttpRequest();
        //xhr.open('GET', 'https://localhost:44322/api/v1/contents');
        xhr.open('GET', 'http://localhost:5000/api/v1/contents/');
        xhr.setRequestHeader('Content-Type', 'application/json');// Access-Control-Allow-Origin
        xhr.onerror = () => {
            console.log(xhr.response);
        }
        xhr.onload = (e) => {
            let c = JSON.parse(xhr.response);
            for(r in c){
                CreateContent(c[r]);
            }
        };
        xhr.send();
    }

    function GetContentsByArtist(data) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:5000/api/v1/contents/'.concat(data));
        xhr.setRequestHeader('Content-Type', 'application/json');// Access-Control-Allow-Origin
        xhr.onerror = () => {
            console.log(xhr.response);
        }
        xhr.onload = (e) => {
            let c = JSON.parse(xhr.response);
            for (r in c) {
                CreateContent(c[r]);
            }
        };
        xhr.send();
    }

    function onClickSearchButton(e) {
        $('#contentsList').empty();

        if($('#searchInput')[0].value == "")
            GetContents();
        else 
            GetContentsByArtist($('#searchInput')[0].value)
    }

    function onClickContent(e) {
        GetMusic(e.children[3].innerHTML);
    }
</script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
            GetContents();
        })
</script>
</html>